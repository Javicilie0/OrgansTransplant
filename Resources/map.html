<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ä—à—Ä—É—Ç –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%);
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* Custom marker styles */
        .custom-marker {
            background: none;
            border: none;
        }

        .marker-icon {
            font-size: 32px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* Popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(26, 26, 46, 0.95);
            color: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .leaflet-popup-content {
            margin: 10px;
            font-size: 14px;
            line-height: 1.6;
        }

        .leaflet-popup-tip {
            background: rgba(26, 26, 46, 0.95);
        }

        .popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #4FACFE;
        }

        .popup-info {
            font-size: 13px;
            color: #E0E0E0;
        }

        /* Hide default routing control */
        .leaflet-routing-container {
            display: none;
        }

        /* Info panel */
        #info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            color: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 280px;
            backdrop-filter: blur(10px);
        }

        #info-panel h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-icon {
            font-size: 20px;
            margin-right: 10px;
            min-width: 25px;
            text-align: center;
        }

        .info-text {
            flex: 1;
        }

        .info-label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 15px;
            font-weight: bold;
        }

        .warning-badge {
            background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
            padding: 8px 12px;
            border-radius: 10px;
            margin-top: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
            animation: pulse 2s infinite;
        }

        .safe-badge {
            background: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
            padding: 8px 12px;
            border-radius: 10px;
            margin-top: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
        }

        .loading-badge {
            background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%);
            padding: 8px 12px;
            border-radius: 10px;
            margin-top: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info-panel">
        <h3>üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h3>
        <div class="info-item">
            <span class="info-icon">üìè</span>
            <div class="info-text">
                <div class="info-label">–†–∞–∑—Å—Ç–æ—è–Ω–∏–µ –ø–æ –ø—ä—Ç–∏—â–∞</div>
                <div class="info-value" id="distance">-- –∫–º</div>
            </div>
        </div>
        <div class="info-item">
            <span class="info-icon">‚è±Ô∏è</span>
            <div class="info-text">
                <div class="info-label">–í—Ä–µ–º–µ –∑–∞ –ø—ä—Ç—É–≤–∞–Ω–µ</div>
                <div class="info-value" id="duration">-- –º–∏–Ω</div>
            </div>
        </div>
        <div class="info-item">
            <span class="info-icon">ü´Ä</span>
            <div class="info-text">
                <div class="info-label">–û—Å—Ç–∞–≤–∞—â–æ –≤—Ä–µ–º–µ –∑–∞ –æ—Ä–≥–∞–Ω–∞</div>
                <div class="info-value" id="organ-time">-- —á</div>
            </div>
        </div>
        <div id="status-badge" class="loading-badge">
            <span class="spinner">‚è≥</span> –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç...
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // Initialize map
        let map;
        let routeControl;
        let currentMarkers = [];

        function initMap() {
            // Create map centered on Bulgaria
            map = L.map('map', {
                zoomControl: true,
                attributionControl: true
            }).setView([42.7339, 25.4858], 7);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Function to create custom icon
        function createCustomIcon(emoji) {
            return L.divIcon({
                html: `<div class="marker-icon">${emoji}</div>`,
                className: 'custom-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }

        // Function to calculate route using OSRM
        function showRoute(fromLat, fromLng, fromName, toLat, toLng, toName, organViabilityHours) {
            if (!map) initMap();

            // Clear existing route and markers
            if (routeControl) {
                map.removeControl(routeControl);
            }
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];

            // Show loading state
            document.getElementById('distance').textContent = '...';
            document.getElementById('duration').textContent = '...';
            document.getElementById('organ-time').textContent = organViabilityHours + ' —á';

            const statusBadge = document.getElementById('status-badge');
            statusBadge.className = 'loading-badge';
            statusBadge.innerHTML = '<span class="spinner">‚è≥</span> –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç...';

            // Create custom icons
            const startIcon = createCustomIcon('üè•');
            const endIcon = createCustomIcon('üéØ');

            // Create routing control with OSRM
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(fromLat, fromLng),
                    L.latLng(toLat, toLng)
                ],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving'
                }),
                lineOptions: {
                    styles: [
                        { color: '#F5576C', opacity: 0.8, weight: 6 },
                        { color: '#FFFFFF', opacity: 0.3, weight: 2 }
                    ],
                    addWaypoints: false
                },
                show: false,
                addWaypoints: false,
                routeWhileDragging: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                showAlternatives: false,
                createMarker: function(i, waypoint, n) {
                    const marker = L.marker(waypoint.latLng, {
                        icon: i === 0 ? startIcon : endIcon,
                        draggable: false
                    });

                    // Add popup
                    if (i === 0) {
                        marker.bindPopup(`
                            <div class="popup-title">üìç –ù–∞—á–∞–ª–Ω–∞ —Ç–æ—á–∫–∞</div>
                            <div class="popup-info">${fromName}</div>
                        `);
                    } else {
                        marker.bindPopup(`
                            <div class="popup-title">üéØ –ö—Ä–∞–π–Ω–∞ —Ç–æ—á–∫–∞</div>
                            <div class="popup-info">${toName}</div>
                        `);
                    }

                    currentMarkers.push(marker);
                    return marker;
                }
            }).addTo(map);

            // Handle routing results
            routeControl.on('routesfound', function(e) {
                const routes = e.routes;
                const route = routes[0];

                // Get distance in kilometers
                const distanceKm = (route.summary.totalDistance / 1000).toFixed(1);

                // Get duration in seconds, convert to hours/minutes
                const durationSeconds = route.summary.totalTime;
                const durationHours = durationSeconds / 3600;
                const durationMinutes = Math.round(durationSeconds / 60);

                // Update info panel
                document.getElementById('distance').textContent = distanceKm + ' –∫–º';

                if (durationMinutes < 60) {
                    document.getElementById('duration').textContent = durationMinutes + ' –º–∏–Ω';
                } else {
                    const hours = Math.floor(durationMinutes / 60);
                    const mins = durationMinutes % 60;
                    document.getElementById('duration').textContent = hours + '—á ' + mins + '–º–∏–Ω';
                }

                // Status badge - compare travel time with organ viability
                if (durationHours < organViabilityHours * 0.5) {
                    statusBadge.className = 'safe-badge';
                    statusBadge.textContent = '‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û - –î–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –≤—Ä–µ–º–µ';
                } else if (durationHours < organViabilityHours * 0.8) {
                    statusBadge.className = 'safe-badge';
                    statusBadge.innerHTML = '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï - –ë–ª–∏–∑–æ –¥–æ –ª–∏–º–∏—Ç–∞';
                    statusBadge.style.background = 'linear-gradient(135deg, #F39C12 0%, #E67E22 100%)';
                } else {
                    statusBadge.className = 'warning-badge';
                    statusBadge.textContent = '‚ùå –û–ü–ê–°–ù–û - –ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –≤—Ä–µ–º–µ!';
                }
            });

            // Handle routing errors
            routeControl.on('routingerror', function(e) {
                console.error('Routing error:', e);
                statusBadge.className = 'warning-badge';
                statusBadge.textContent = '‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç';

                // Fallback to straight line
                const distance = map.distance([fromLat, fromLng], [toLat, toLng]) / 1000;
                const approximateDistance = (distance * 1.3).toFixed(1);

                document.getElementById('distance').textContent = '~' + approximateDistance + ' –∫–º';
                document.getElementById('duration').textContent = '–ù—è–º–∞ –¥–∞–Ω–Ω–∏';
            });
        }

        // Initialize map on load
        window.addEventListener('load', initMap);

        // Expose function to C#
        window.showRoute = showRoute;
    </script>
</body>
</html>
